************************
Numina Pipeline Concepts
************************

Instrument
##########


Observing Modes
###############
Each instrument has a list of predefined types of observations that can be
carried out with it. Some types of observations provide calibrations needed by
other types of observations.

.. digraph:: foo

   "Observation Mode" -> "Pipeline 1";
   "Observation Mode" -> "Pipeline 2";
   "Observation Mode" -> "...";
   "Observation Mode" -> "Pipeline N";

Pipelines
#########
A pipeline represents a particular mapping between the observing modes and the
reduction algorithms that process each mode. Each instrument has at least one
pipeline.

.. digraph:: foo

   "Pipeline" -> "Recipe 1";
   "Pipeline" -> "Recipe 2";
   "Pipeline" -> "....";
   "Pipeline" -> "Recipe N";

Recipes
#######
A recipe is a method to process the images obtained in a particular observing
mode. Recipes in general require (as inputs) the list of raw images obtained 
during the observation. Recipes can require other inputs (calibrations), and 
those inputs can be the outputs of other recipes.

Products, Requirements and Data Types
#####################################
A recipe announces its required inputs as Requirements and its outputs as
Products.

Both products and requirements have a name and a type. Types can be plain
Python types or defined by the developer.

Format of the input files
#########################

The default format of the input and output files is YAML_, a data
serialization language.

Format of the Observation Result file
*************************************
This file contains the result of a observation. It represents a
:class:`numina.recipes.oblock.ObservationResult` object.

The contents of the object are serialized as a dictionary with the
following keys:

id: not required, integer, defaults to 1
    Unique identifier of the observing block

instrument: required, string
    Name of the instrument, as it appears in the instrument file
    (see below)

mode: required, string
    Name of the observing mode

children: not required, list of integers, defaults to empty list
    Identifications of nested observing blocks

images: required, list of file names
    List of raw images

.. code-block:: yaml

   id: 21
   instrument: EMIR
   mode: nb_image
   children: []
   images:
   - r0121.fits
   - r0122.fits
   - r0123.fits
   - r0124.fits
   - r0125.fits
   - r0126.fits
   - r0127.fits
   - r0128.fits
   - r0129.fits
   - r0130.fits
   - r0131.fits
   - r0132.fits

Format of the requirement file (version 1)
******************************************
.. code-block:: yaml

    version: 1
    products:
      EMIR:
       - {id: 1, content: 'file1.fits', type: 'MasterFlat', tags: {'filter': 'J'}, ob: 200}
       - {id: 4, content: 'file4.fits', type: 'MasterBias', tags: {'readmode': 'cds'}, ob: 400}
      MEGARA:
       - {id: 1, content: 'file1.fits', type: 'MasterFlat', tags: {'vph': 'LR1'}, ob: 1200}
       - {id: 2, content: 'file2.yml', type: 'TraceMap', tags: {'vph': 'LR2', 'readmode': 'fast'}, ob: 1203}
    requirements:
      EMIR:
        default:
           TEST6:
              pinhole_nominal_positions: [ [0, 1], [0 , 1]]
              box_half_size: 5
           TEST9:
              median_filter_size: 5
    MEGARA:
        default:
           mos_image: {}


Format of the requirement file
******************************
.. warning::
   This section documents a deprecated format

.. deprecated:: 0.14.0

This file contains configuration parameters for the recipes that
are not related to the particular instrument used.

The contents of the file are serialized as a dictionary with the
following keys:

requirements: required, dictionary
    A dictionary of parameter names and values.

logger: optional, dictionary
    A dictionary used to configure the custom file logger

.. code-block:: yaml

   requirements:
     master_bias: master_bias-1.fits
     master_bpm: bpm.fits
     master_dark: master_dark-1.fits
     master_intensity_ff: master_flat.fits
     nonlinearity: [1.0, 0.0]
     subpixelization: 4
     window:
     - [800, 1500]
     - [800, 1500]
   logger:
     logfile: processing.log
     format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
     enabled: true

Generating template requirement files
#####################################
Template requirement files can be generated by :program:`numina show-recipes`
The flag generates templates for the named recipe or for all the available
recipes if no name is passed.

For example::

  $ numina show-recipes -t emir.recipes.DitheredImageRecipe
  # This is a numina 0.9.0 template file
  # for recipe 'emir.recipes.DitheredImageRecipe'
  #
  # The following requirements are optional:
  #  sources: None
  #  master_bias: master_bias.fits
  #  offsets: None
  # end of optional requirements
  requirements:
    check_photometry_actions: [warn, warn, default]
    check_photometry_levels: [0.5, 0.8]
    extinction: 0.0
    iterations: 4
    master_bpm: master_bpm.fits
    master_dark: master_dark.fits
    master_intensity_ff: master_intensity_ff.fits
    nonlinearity: [1.0, 0.0]
    sky_images: 5
    sky_images_sep_time: 10
  #products:
  # catalog: None
  # frame: frame.fits
  #logger:
  # logfile: processing.log
  # format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
  # enabled: true
  ---

The # character is a comment, so every line starting with it can safely
removed. The names of FITS files in requirements must be edited to point
to existing files.



.. _YAML: http://www.yaml.org